#!/usr/bin/env bash
#
# Pre-commit validation orchestrator for JsonSuperSet
#
# Runs all pre-commit checks in sequence:
# 1. Documentation check (README.md & files.md in every folder)
# 2. JSDoc validation (all JS files have proper documentation)
# 3. TypeScript definitions check (index.d.ts matches index.js exports)
# 4. Test coverage check (100% coverage required)
# 5. Yoda conditions (literal on left side of comparisons)
#
# Exit codes:
#   0 - All checks passed
#   1 - One or more checks failed

set -e

# Determine script location (works whether run from .git/hooks or .hooks)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Handle both direct execution (.hooks/) and git hook execution (.git/hooks/)
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    CHECKS_DIR="$SCRIPT_DIR/pre-commit.d"
else
    CHECKS_DIR="$SCRIPT_DIR/pre-commit.d"
fi

# Project root is always two levels up from .git/hooks or one level up from .hooks
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

cd "$PROJECT_ROOT"

ERROR=0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_header() {
    echo ""
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}  $1${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

run_check() {
    local script="$1"
    local name="$2"

    if [ ! -f "$script" ]; then
        echo -e "${RED}  ✗ Check script not found: $script${NC}"
        ERROR=1
        return
    fi

    echo ""
    echo -e "  Running: $name"

    if [ -x "$script" ]; then
        if "$script"; then
            echo -e "${GREEN}  ✓ $name passed${NC}"
        else
            echo -e "${RED}  ✗ $name failed${NC}"
            ERROR=1
        fi
    else
        # Try with bash if not executable
        if bash "$script"; then
            echo -e "${GREEN}  ✓ $name passed${NC}"
        else
            echo -e "${RED}  ✗ $name failed${NC}"
            ERROR=1
        fi
    fi
}

print_header "Pre-commit Checks"

# Run all checks
run_check "$CHECKS_DIR/check-docs.sh" "Documentation (README.md & files.md)"
run_check "$CHECKS_DIR/check-jsdoc.sh" "JSDoc Validation"
run_check "$CHECKS_DIR/check-typescript.sh" "TypeScript Definitions"
run_check "$CHECKS_DIR/check-coverage.sh" "Test Coverage (100%)"
run_check "$CHECKS_DIR/check-yoda.sh" "Yoda Conditions"

echo ""
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [ $ERROR -eq 1 ]; then
    echo -e "${RED}  ✗ Commit blocked: One or more checks failed${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}  ✓ All pre-commit checks passed${NC}"
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
exit 0
